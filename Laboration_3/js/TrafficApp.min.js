"use strict";var TrafficApp={trafficURL:"http://api.sr.se/api/v2/traffic/messages?pagination=false&format=json",fileMaxTime:10,map:{},incidents:[],markers:[],categories:["Alla kategorier","Vägtrafik","Kollektivtrafik","Planerad störning","Övrigt"],months:["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"],init:function(){TrafficApp.renderTrafficMap(),TrafficApp.populateCategoryFilter(),TrafficApp.getTrafficMessages()},getTrafficMessages:function(){var e,t;if(TrafficApp.isTrafficFresh()===!0)t=JSON.parse(localStorage.getItem("traffic-expire")).timestamp,e=JSON.parse(localStorage.getItem("traffic")),TrafficApp.renderTraffic(e,t);else{var a,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(200===r.status){a=JSON.parse(r.responseText),e=a.messages,t=(new Date).getTime();var i={timestamp:t};localStorage.setItem("traffic",JSON.stringify(e)),localStorage.setItem("traffic-expire",JSON.stringify(i))}else console.log("An error occurred while retrieving new traffic, using traffic from cache."),e=JSON.parse(localStorage.getItem("traffic"));TrafficApp.renderTraffic(e,t)}},r.open("GET",TrafficApp.trafficURL,!0),r.send(null)}},isTrafficFresh:function(){var e=localStorage.getItem("traffic"),t=localStorage.getItem("traffic-expire");if(null!==e&&null!==t){var a=JSON.parse(t).timestamp,r=(new Date).getTime();if(r-a<1e3*TrafficApp.fileMaxTime*60)return console.log("Still fresh"),!0}return console.log("Not fresh"),!1},renderTraffic:function(e,t){TrafficApp.renderMarkers(e),TrafficApp.renderTrafficList(e),TrafficApp.addClickEvents(e);var a=TrafficApp.parseDate(t);$("#traffic-header").append("<p>Trafikhändelserna hämtades den "+a+"<br>Händelserna är sorterade efter datum, nyaste först.<br>Nästa hämtning sker som tidigast "+TrafficApp.fileMaxTime+" min efter den senaste hämtningen.</p>")},renderTrafficMap:function(){TrafficApp.map=new L.Map("map");var e="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",t='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',a=new L.TileLayer(e,{minZoom:5,maxZoom:16,attribution:t});TrafficApp.map.setView(new L.LatLng(60,15),6),TrafficApp.map.addLayer(a)},renderMarkers:function(e){TrafficApp.markers.forEach(function(e){TrafficApp.map.removeLayer(e)}),e.forEach(function(e){var t=new L.Marker([e.latitude,e.longitude]),a="<b>Titel: </b>"+e.title,r="<br><b>Kategori: </b> "+e.subcategory,i="<br><b>Datum: </b>"+TrafficApp.parseDate(e.createddate),n=""!=e.exactlocation?"<br><b>Plats: </b>"+e.exactlocation:"",f=""!=e.description?"<br><b>Beskrivning: </b>"+e.description:"",p=a+i+r+n+f;t.bindPopup(p),t.addTo(TrafficApp.map),t.on("click",function(t){TrafficApp.map.setView([e.latitude,e.longitude],14);var a=t.target._popup._content.split("<br>")[0].split("</b>")[1];$(".incident").each(function(e,t){t.text===a&&($(".incident-details").hide(),$(this).next().slideDown("fast"))})}),TrafficApp.markers.push(t)})},renderTrafficList:function(e){e.sort(function(e,t){return new Date(TrafficApp.parseDate(t.createddate))-new Date(TrafficApp.parseDate(e.createddate))});var t=$("#traffic-ul");t.empty(),void 0===e||0===e.length?t.append("<p'>Det finns inga händelser för denna kategori.</p>"):e.forEach(function(e){var a="Datum: "+TrafficApp.parseDate(e.createddate),r="<br>Händelse: "+e.subcategory,i=""!=e.exactlocation?"<br>Plats: "+e.exactlocation:"",n=""!=e.description?"<br>Beskrivning: "+e.description:"",f=a+r+i+n;t.append("<li><a class='incident category"+e.category+"' href='#'>"+e.title+"</a><p class='incident-details'>"+f+"</p></li>")}),$(".incident-details").hide()},addClickEvents:function(e){$(".incident").on("click",function(t){t.preventDefault(),$(".incident-details").hide(),$(this).next().slideDown("fast");var a,r,i=$(this).html();e.forEach(function(e){e.title===i&&(a=e.latitude,r=e.longitude)}),TrafficApp.map.setView([a,r],14),TrafficApp.markers.forEach(function(e){e._popup._content.indexOf(i)>=0&&e.openPopup()})}),$("#reset-btn").on("click",function(){TrafficApp.map.setView([60,15],6),$("#filter").val(0);var e=$(".leaflet-popup-close-button")[0];void 0!=e&&e.click(),$(".incident-details").hide()}),$("#filter").on("change",function(){var t=[],a=$("#filter").val();e.forEach(function(e){"0"===a?t.push(e):e.category===a-1&&t.push(e)}),TrafficApp.renderMarkers(t),TrafficApp.renderTrafficList(t),TrafficApp.addClickEvents(e)})},populateCategoryFilter:function(){for(var e="",t="",a=0;a<TrafficApp.categories.length;a++)e+="<option value='"+a+"'>"+TrafficApp.categories[a]+"</option>",a<TrafficApp.categories.length-1&&(t+="<p class='category"+a+"'>"+TrafficApp.categories[a+1]+"</p>");$("#filter-desc").append(t),$("#filter").append(e)},parseDate:function(e){return 13===e.toString().length?e=new Date(e):(e=e.substr(6,18),e=new Date(parseInt(e))),e.getDate()+" "+TrafficApp.months[e.getMonth()]+" "+e.getFullYear()+" "+TrafficApp.addZeroBefore(e.getHours())+":"+TrafficApp.addZeroBefore(e.getMinutes())},addZeroBefore:function(e){return(10>e?"0":"")+e}};window.onload=new TrafficApp.init;